该项目结合了U-Net架构的优点和变分自编码器（VAE）的原理，用于在只有正常样本的情况下学习数据的“正常”表示，从而识别异常（缺陷）。
## 1.学习正常模式 (VAE核心)：
  * **编码器 (Encoder)**： U-Net的下采样路径充当编码器。它将输入的正常图像压缩（编码）成一个低维的潜在向量（latent vector）。与标准AE不同，VAE的编码器输出的是该潜在向量所服从的高斯分布的参数：均值 (μ) 和对数方差 (log(σ^2))。
  * **潜在空间 (Latent Space)**： 通过重参数化技巧 (z = μ + σ * ε，其中ε是随机噪声），从学习到的分布中采样得到潜在向量z。
  * **解码器 (Decoder)**： U-Net的上采样路径充当解码器。它接收潜在向量z作为输入，并尝试将其重构回原始的输入图像。
  * **损失函数**：
  * **重构损失 (Reconstruction Loss)**： 例如BCE Loss或L1 Loss，用于惩罚重构图像与原始输入图像之间的差异。这迫使模型学习如何精确复制正常样本。
  * **KL散度损失 (KL Divergence Loss)**： 作为一个正则化项，它约束编码器产生的潜在分布 q(z|x) 接近一个预设的先验分布 p(z)（通常是标准正态分布）。这有助于形成一个平滑、连续且有结构的潜在空间，防止模型过拟合，并提高泛化能力。总损失是这两部分的加权和，其中KLD_WEIGHT（即β）控制着KL散度项的相对重要性。
# 2.U-Net的贡献：高质量重构与细节保留：
  * **跳跃连接 (Skip Connections)**： U-Net架构的关键。它将编码器在不同尺度下提取的特征图直接传递并拼接（concatenate）到解码器对应尺度的层上。
  * **效果**： 这些跳跃连接为解码器提供了丰富的低级、高分辨率细节信息（如边缘、纹理），这些信息在标准AE的瓶颈层中很容易丢失。因此，U-Net VAE能够比标准VAE（尤其是在高分辨率图像上）生成更清晰、细节更丰富的重构图像。
# 3.无监督缺陷检测逻辑：
  * **训练**： 模型只在大量正常样本上进行训练。它学习如何将正常图像编码到规整的潜在空间，并从潜在表示中高质量地重构出这些正常图像。
  * **检测**：
  * 当输入一张正常图像时，模型能够很好地重构它，因此原始图像与重构图像之间的差异（即重构误差，作为异常分数）会很小。
  * 当输入一张包含缺陷的图像时，由于缺陷模式是模型在训练中未见过的“异常”，编码器可能难以将其有效地表示在“正常”的潜在空间区域，或者解码器在尝试用已学习的“正常”模式去重构这个包含异常的图像时，会在缺陷区域产生较大的偏差。因此，缺陷图像的重构误差会显著高于正常图像。
  通过设定一个重构误差的阈值，就可以区分出正常样本和缺陷样本。
  * 计算原始图像和重构图像之间的差异图（例如，逐像素的绝对差值或平方差），可以高亮显示重构误差较大的区域，从而实现缺陷的定位和可视化。

检测流程：
# 1.数据准备（离线）：
  * 收集大量高质量的正常样本图像（例如，无缺陷的木材图像）作为训练集。
  * （推荐）准备一个包含已知正常样本和各种已知缺陷样本的混合验证集/测试集，用于调整阈值和全面评估模型性能。确保缺陷样本不参与训练。
  * 对所有图像进行统一的预处理：调整到固定尺寸（例如，你代码中的512x512），转换为PyTorch张量，并可能进行归一化。
# 2.模型训练（离线）：
  * 定义U-Net VAE模型结构，包括其编码器下采样路径、解码器上采样路径以及两者之间的跳跃连接。
  * 定义损失函数（重构损失 + 加权的KL散度损失）。
  * 选择优化器（如Adam）。
  * 仅使用正常样本图像对U-Net VAE模型进行训练。模型学习最小化重构误差，同时使潜在表示符合先验分布。
  * 监控训练过程中的总损失、重构损失、KL散度，并定期查看正常样本的重构图像质量。
  * 训练完成后，保存学到的模型权重。
# 3.确定异常分数阈值（离线，使用验证集）：
  * 加载训练好的U-Net VAE模型。
  * 将验证集中的所有样本（正常和缺陷）输入模型，计算每个样本的异常分数（通常基于重构误差，例如你代码中评估时使用的平均L1损失）。
  * 分析正常样本和缺陷样本的异常分数分布。
  * 选择一个合适的阈值，以最好地区分这两类样本，平衡误报率和漏报率（例如，通过ROC曲线、PR曲线或F1分数最大化来确定）。
# 4.在线缺陷检测/推理（实际应用）：
  * 加载训练好的U-Net VAE模型和确定的异常分数阈值。
  * 获取新的待检测图像，并进行与训练时相同的预处理。
  * 将预处理后的图像输入模型，得到重构图像。
  * 计算该图像的异常分数。
  * **判断(还没实现)**：
  * 如果异常分数 > 阈值，则判定为缺陷图像。
  * 否则，判定为正常图像。
  * **缺陷定位**：
  * 计算原始输入图像与重构图像之间的差异图。
  * 对差异图进行可视化（如热力图）或进一步的图像处理（如阈值化、连通组件分析），以高亮显示和分割出潜在的缺陷区域。
   
  * U-Net VAE通过其强大的细节重构能力，为基于重构的无监督异常检测提供了一个非常有力的工具，尤其适用于那些对重构质量要求较高的场景。

# 基于U-Net VAE的木材表面无监督缺陷检测

本项目利用U-Net结构的变分自编码器（U-Net VAE）实现对木材表面图像的无监督缺陷检测。模型通过学习大量正常木材样本的特征，能够高质量地重构正常图像。当输入包含缺陷的木材图像时，其重构图像与原始图像之间会产生较大的差异（重构误差），从而可以识别并定位缺陷。

## 项目亮点

*   **无监督学习：** 仅需“良好”的木材样本进行训练，无需人工标注缺陷。
*   **高质量图像重构：** 采用U-Net架构，通过跳跃连接有效保留并重构图像细节，即使在高分辨率（如512x512）下也能获得清晰的重构效果。
*   **高缺陷检测性能：** 经过参数调优，在木材数据集上取得了优异的AUC指标（例如，ROC AUC > 0.92, PR AUC > 0.97）。
*   **缺陷定位：** 通过计算原始图像与重构图像的差异图，可以直观地显示潜在缺陷的位置和形状。
*   **可配置与可扩展：** 代码结构清晰，方便调整超参数、网络结构或替换数据集。
